---
title: 笔记-深入拆解Java虚拟机-10Java对象的内存分布
date: 2018-08-29 09:38:58
tags: JVM
categories: Java虚拟机
---

# Java 新建对象的方式

- new 语句
- 反射
- Object.clone方法
- 反序列化
- Unsafe.allocateInstance方法

# 压缩指针

## 对象头（object header）

- 每个 Java 对象都有。
- 由**标记字段、类型指针**构成。
- 标记字段：存储 Java 虚拟机有关该对象的运行数据（如哈希码、GC 信息、锁信息）。
- 类型指针：指向该对象的类。
- 64 位Java虚拟机中，对象头占 16 个字节。

## 压缩指针

- 开启压缩指针：-XX:+UseCompressedOops（默认开启）。
- **将堆中原本 64 位的 Java 对象指针压缩成 32 位。**
- 类型指针也被压缩成 32 位，**对象头的大小从 16 字节降至 12 字节。**
- 还可以作用于**引用类型的字段**，**引用类型数组**。

# 内存对齐

- 虚拟机选项 -XX:ObjectAlignmentInBytes，默认值为 8。
- 默认情况，堆中对象（包括字段之间）起始地址要对齐至 8 的倍数。
- 浪费掉的空间称之为对象间的填充（padding）。
- 32 位压缩指针可以寻址到 2 的 35 次方个字节（32GB 地址空间，超过 32GB 会关闭压缩指针）。
- 压缩指针解引用：左移 3 位，再加上一个固定偏移量。
- 字段内存对齐的一个原因：**让字段只出现在同一 CPU 的缓存行中**。**不懂**

# 字段重排列

- Java 虚拟机重新分配字段的顺序，达到内存对齐

# 参考

> https://time.geekbang.org/column/article/13081