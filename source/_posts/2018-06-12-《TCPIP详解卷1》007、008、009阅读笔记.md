---
title: '「TCP/IP详解 卷1」007、008、009 阅读笔记'
date: 2018-06-12 20:32:56
tags: [计算机网络,TCP,IP]
categories: 《TCP/IP详解 卷1》
---

# 007，Ping 的工作原理

## Unix 系统的实现

- 把 ICMP 报文中标识符字段设置成发送进程的 ID 号（识别多个 Ping 程序实例）。

- 序列号从 0 开始，每发送一次新的回显请求就 + 1。

- Ping 程序允许我们查看是否有分组丢失、失序或重复。

## 旧版本 Ping 程序

- 每秒发送一个回显请求。

- 打印返回的每个分组的每个回显应答。

## 新版本 Ping 程序

- 需要加上 - s 选项以旧版本模式运行。

- Ping 程序只发送一个回显请求。

- 收到回显应答输出 “host is alive”，20 秒内没收到输出 “no answer”。

# 008，Traceroute 的工作原理

- 每个处理数据报的路由器都要把 TTL 的值减 1 或停留的秒数。

- 大多数路由器转发数据报的时延都小于 1 秒，TTL 最终成为一个跳站计数器。

- 如果 TTL 字段是 1，路由器将该数据报丢弃，并向信源机放一份 ICMP “超时”信息。

- Traceroute 程序发送一份 TTL 字段为 1 的 IP 数据报为目的主机，第一个路由器丢弃并发回超时 ICMP 报文，然后 Traceroute 程序发送一份 TTL 字段为 2 的数据报，得到第二个路由器的地址，以此类推。

- 目的主机收到 TTL 值为 1 的 IP 数据报，不会丢弃并产生 ICMP 超时报文。

- Traceroute 程序发送一份不可能值作为 UDP 端口号（大于 30000）的 UDP 数据报给目的主机，目的主机产生一份“端口不可达”错误的 ICMP 报文。

- Traceroute 程序区分收到的 ICMP 报文是超时还是端口不可达判断是否结束。

# 009，IP 包选路的工作原理

## 选路的原理

- IP 搜索路由表的步骤：

    1. 搜索匹配的主机地址。

    2. 搜索比配的网络地址。

    3. 搜索默认表项。

- IP 层进行的选路是一种选路机制，它搜索路由表并决定向哪个网络接口发送分组。

- 选路策略决定把哪些路由放入路由表的规则，路由守护程序提供选路策略。

## 初始化路由表

- 在系统引导时显示地的在初始化文件中运行 route 命令。

## 没有到达目的地的路由

路由表中没有默认项，又没有找到匹配项。

- 数据报由本地主机产生：向应用程序返回一个“主机不可达差错”或“网络不可达差错”。

- 被转发的数据报：向原始发送端发送一份 ICMP 主机不可达差错报文。

## ICMP 重定向差错

- 当数据报应该被发送到另一个路由器时，收到数据报的路由器要发送 ICMP 重定向差错报文给 IP 数据报的发送端。

- 重定向一般用来让具有很少选路信息的主机逐渐建立更完善的路由表。

## ICMP 重定向报文

- 重定向报文只能由路由器生成。

- 重定向报文是为主机使用的。

## ICMP 路由器发现报文

- 一份报文可以通告多个地址。

- 路由器启动时定期在所有广播或多播传送接口上发送通告报文。

- 某个接口被关闭时，该接口上发送一份通告报文，生命周期值设为 0。

- 监听来自主机的请求报文，并发送通告报文以响应。

- 主机在引导期间发送请求报文。

- 监听来自相邻路由器的请求报文。
