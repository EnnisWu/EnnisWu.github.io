---
title: '「深入拆解 Java 虚拟机」25 循环优化'
date: 2018-11-24 18:59:41
tags: JVM
categories: 《深入拆解 Java 虚拟机》
---

原文：https://time.geekbang.org/column/article/39814

# 循环无关代码外提

> 所谓的循环无关代码（Loop-invariant Code），指的是循环中值不变的表达式。

- 在**不改变程序语义**的情况下，将**循环无关代码提出循环之外**。

## 外提循环中值不变的表达式

- 通过 Sea-of-Nodes IR 以及节点调度共同完成。

## 外提循环无关检测

- 通过循环预测（Loop Prediction）完成。

比如 null 检测（null check），数组下标范围检测（range check）。

null 检测涉及控制流依赖，无法通过 Sea-of-Nodes IR 转换以及节点调度外提。

# 循环展开（Loop Unrolling）

> 指的是在循环体中重复多次循环迭代，并**减少循环次数**的编译优化。

- 在 C2 中，**只有计数循环**（Counted Loop）才能被展开。

- 随着循环体的增大，优化机会不断增加。

- 如果循环展开能够触发进一步优化，总体的代码复杂度将降低。

- 缺点：可能会**增加代码的冗余度**，导致所生成机器码的长度大幅上涨。

## 循环完全展开（Full Unroll）

- 当**循环数目**是**固定值**而且**非常小**时，会将**循环全部展开**（Full Unroll）。

- 仅迭代三次（或以下）的循环，即时编译器将进行完全展开。

- 循环体 IR 节点数目超过阈值的循环，即时编译器不会进行任何循环展开。

## 计数循环需满足的 4 个条件

1. 维护一个循环计数器，并且基于计数器的循环出口只有一个（但可以有基于其他判断条件的出口）。

2. 循环计数器的类型为 int、short 或者 char（即不能是 byte、long，更不能是 float 或者 double）。

3. 每个迭代循环计数器的增量为常数。

4. 循环计数器的上限（增量为正数）或下限（增量为负数）是循环无关的数值。

# 循环判断外提（loop unswitching）

> 指的是**将循环中的 if 语句外提至循环之前**，并且在该 if 语句的两个分支中分别放置一份循环代码。

- 与循环无关检测外提所针对的代码模式比较类似。

# 循环剥离（loop peeling）

> 指的是将循环的前几个迭代或者后几个迭代剥离出循环的优化方式。

- 一般来说，循环的**前几个迭代**或者**后几个迭代**都包含**特殊处理**。

- 剥离出去后，可以**使原本的循环体的规律性更加明显**，触发进一步的优化。

# 问题

Q：

如果有这样一段代码：

```java
for ( ... ) {
	sum += x + y + a[i];
}
```

借助 Sea-of-Nodes IR 能把 x + y 表达式外提出去。但，如果表达式变成如下：

```java
sum += x + a[i] + y;
```

也能借助 IR 外提  x + y 吗？

A：能。
