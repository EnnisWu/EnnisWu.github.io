---
title: 《TCP/IP详解卷1》003阅读笔记
date: 2018-06-02 15:07:17
tags: [计算机网络,TCP/IP]
categories: TCP/IP
---

IP的正式规范文件：RFC 791

所有TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。
不可靠：不能保证IP数据报能够成功到达目的地。可靠性必须由上层提供。
无连接：IP不维护后续数据报的状态信息。每个数据报的处理相互独立。IP数据报可以不按发送顺序接收。

传输次序：网络字节序/big endian（大端）字节序

#### IP首部字段
| 字段名 | 长度 |   |
| ----- | ---- | ---- |
| 版本 | 4位 | 4 |
| 首部长度 | 4位 | 首部占32bit字的数目，没有任何选项，值为5，首部最长60字节 |
| 服务类型（TOS） | 8位 | 3bit优先权子字段（已忽略），4bitTOS子字段，1bit未用位（置为0） |
| 总长度 | 16位 | 字节为单位，最长65535字节。**必要内容** |
| 位标识 | 16位 | 唯一标识主机发送的每一份数据报 |
| 位标志 | 3位 |  |
| 位片偏移 | 13位 |  |
| 生存时间（TTL） | 8位 | 经过的最多路由器数，初始值通常为64或32，源主机设置。 |
| 协议 | 8位 |  |
| 首部校验和 | 16位 | 根据IP首部计算校验和码。 |
| 选项 |  | 可选，可变长。32bit为界限，不够时插入值为0的填充字节。 |

- 首部长度：从包头格式图看出，是以32bit为一行的，一行包括若干字段。首部长度的数值是以32bit为单位来描述的，比如四位全为1，十六进制本来是0X0F，也就是十进制的15但是，**这个字段的1不是数值1，而是指1个单位即一个32bit。**所以如果该字段是1111的话。就是15*32bit=60Byte了。 
- 4bit的TOS代表：最小时延、最大吞吐量、最高可靠性、最小费用。
- 首部长度、总长度计算数据内容的起始位置和长度。
- TTL为0时丢弃数据报，发送ICMP报文通知源主机。
- 首部校验和：如果校验和错误，丢弃数据报，但不生成差错报文，由上层发现并重传。

#### IP路由选择
目的主机与源主机直接相连，或都在一个共享网络上，IP数据报直接送到目的主机。
否则发往默认路由，由路由器转发。
<br/>

###### IP层可以配置成路由器或主机
主机：不转发
路由器：转发
内含路由器的主机：不转发
<br/>

###### 收到数据报来自网络接口时（即非本地生成的数据报）
-  检查IP地址
   - 是本机IP地址之一或IP广播地址：发送到指定协议模块
     - IP层设置为路由器：转发
     - 否则：丢弃
<br/>

###### 路由表
| 项 | 含义 |
| - | - |
| 目的IP地址 | 表中标志字段指定类型。完整的主机地址：非0主机号。网络地址：主机号为0。 |
| 下一跳路由器IP地址 | 或者有直接连接的网络IP地址。 |
| 标志 | 一个指明目的IP地址类型，==**一个标志下一站路由器时真下一站路由器还是直接相连的接口。**看不懂这句== |
| 指定网络接口 |  |

IP不知道目的的完整路径
<br/>

###### IP路由选择主要功能
搜索路由表
1. 寻找与目的IP完全匹配（网络号和主机号）的条目
2. 寻找与目的网络号相匹配的条目（必须考虑子网掩码）
3. 寻找“默认”的条目

如果找到，报文发送指定的下一站路由器或直接相连的网络接口。
如果都未成功，则不能被传送，向应用返回错误
<br/>

#### 子网寻址
==看不懂图==
- 所有主机都要求支持子网寻址。
- IP地址 = 网络号 + 子网号 + 主机号
- B类IP地址 = 网络号（16位）+ 子网号（8位）+ 主机号（8位）
- 子网对外部路由器来说隐藏了内部网络组织。
- 子网划分缩减了路由表的规模。
- 子网对于子网内部的路由器不透明。==不懂==

#### 子网掩码
- 标识多少bit用于子网号，多少bit用于主机号。
- 掩码是32bit的值，值为1留给网络号和子网号，值为0留给主机号。
- 给定IP地址和子网掩码后可以确定：
- 1. 本子网上的主机。
- 2. 本网络中其他子网中的主机。
- 3. 其他网络上的主机。